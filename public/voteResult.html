<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>2017杭电十佳教师评选-投票结果</title>
    <script src="./js/utils.js" type="text/javascript"></script>
    <script src="./js/teacherData.js" type="text/javascript"></script>
    <script src="./js/echarts.min.js" type="text/javascript"></script>
    <script src="./js/jquery-2.0.0.min.js" type="text/javascript"></script>
    <link rel="stylesheet" href="./css/common.css">
    <link rel="stylesheet" href="./css/utils.css">
    <link rel="stylesheet" href="./css/bars.css">
</head>
<style>
    .topContainer .topTitle {
        color: white;
    }

    /***********************************************/
    .voteResult .timebar {
        margin-top: 65px;
    }

    .voteResult .timebar img {
        margin-right: 2%;
        width: 20px;
        display: inline-block;
    }

    .voteResult .timebar .checkbox {
        display: inline-block;
        margin-left: 40%;
    }

    .voteResult .timebar .checkbox span {
        margin: 20px;
        color: #999999;
    }

    .voteResult .timebar .timeleft {
        margin-right: 4%;
        font-size: 22px;
        letter-spacing: 4px;
    }

    /***********************************************/

    .voteResult #map {
        margin-top: 25px;
        width: 100%;
        height: 720px;
    }


</style>
<body class="voteResult">
<div class="topbar">
    <div class="topbarContainer">
        <img src="./pic/logo.png" class="logo" alt=" ">
        <div class="title active">
            <div>实时计票台</div>
        </div>
    </div>
</div>
<div class="timebar">
    <div class="timeleft">00:00:00</div>
    <img src="./pic/icon/开始.png" alt=" " title="计时开始" class="timeStart">
    <img src="./pic/icon/重置.png" alt=" " title="重新计时" class="timeReset">
    <div class="checkbox">
        <span><input type="checkbox" id="show10">显示前十名</span>
        <span><input type="checkbox" id="showTicket">显示具体票数</span>
    </div>
</div>
<div id="map"></div>
<div class="copyright">@ 2017.Powered by RedHome Studio 红色家园</div>
</body>
</html>
<script>
    $(function () {

        //检查是否有权限
        var session = localStorage.getItem("session");
        if (session != 'admin') {
            alert("请先登录");
            window.location.href = './login.html';
        }


        $.ajax({
            method: "get",
            url: "/common/time",
            success: function (data) {
                if (data.duration == 0 || data.time == 0) {
                    return;
                }
                if (data.time + data.duration * 60 * 1000 < new Date().getTime()) {
                    //over
                    return;
                }
                timeCount(data.time, data.duration, function () {
                });
            },
            error: function () {
                alert("服务器开小差了哦~");
            }
        })

        //设定时长
        var duration = 1;
        $('.timeleft').html("00:" + num2txt(duration) + ":00");
        $('.timeStart').on("click", function () {
            $.ajax({
                method: "get",
                url: "/admin/start?duration=" + duration,
                success: function () {
                    $.ajax({
                        method: "get",
                        url: "/admin/reset",
                        success: function () {
                            location.reload();
                        }
                    })
                },
                error: function (data) {
                    alert(data.msg);
                }
            })
        })


        $('.timeReset').on("click", function () {
            $.ajax({
                method: "get",
                url: "/admin/start?duration=0",
                success: function () {
                    $.ajax({
                        method: "get",
                        url: "/admin/reset",
                        success: function () {
                            location.reload();
                        }
                    })
                }
            })
        })


    });

</script>
<script name="map_var">
    var voteResult = [];
    $.ajax({
        async:false,
        method: "get",
        url: "/common/getResult",
        success: function (data) {
            voteResult = sortOut(data);
        }
    });
    var map = echarts.init(document.getElementById("map"));
    var show10, ticket;            //checkbox监听
    var tchrList, data;             //中间容器
    var tchrAll = [];
    var tchr10 = [];
    var dataAll=[];
    var data10=[];
    function orderById(a,b) {
        return a-b;
    }
    teacherInfo.forEach(function (e) {
        tchrAll.push(e.teacher);
        dataAll.push((voteResult.sort(orderById))[e.id-1].number_of_votes)
    });

    voteResult.forEach(function (e,i) {
        console.log(e);
        if (i>9)return;
        tchr10.push(teacherInfo[e.id-1].teacher);
        data10.push(e.number_of_votes);
    });

    function num(a) {
        switch (a) {
            case true:
                return 10;
            default:
                return 19;
        }
    }


</script>

<script name="map">

    //条形图
    var option;
    function makemap() {
        show10 = $("#show10").prop("checked");
        ticket = $("#showTicket").prop("checked");
        tchrList = (show10 == true) ? tchr10 : tchrAll;
        data = (show10 == true) ? data10 : dataAll;
        option = {
            xAxis: [
                //条形图
                {
                    data: function () {
                        var list = [];
                        for (var i = 1; i <= num(show10); i++) {
                            list.push(i);
                        }
                        return list;
                    }(),
                    axisLabel: {                            //坐标对象
                        inside: true,
                        textStyle: {
                            fontSize: 14,
                            color: '#fff'
                        }
                    },
                    axisTick: {
                        show: false                         //坐标刻度
                    },
                    axisLine: {
                        show: false                         //坐标轴显示
                    },
                    z: 10                                   //视深
                },
                // 教师表
                {
                    position: "bottom",
                    data: tchrList,
                    axisLabel: {                            //坐标对象
                        show: true,
                        textStyle: {
                            color: "#666666",
                            fontSize: 13
                        }
                    },
                    splitNumber: 4,
                    splitLine: {
                        lineStyle: {
                            type: "dashed"
                        }
                    },
                    axisTick: {
                        show: false                         //坐标刻度
                    },
                    axisLine: {
                        show: false                         //坐标轴显示
                    },
                    offset: 10                              //向下偏移量
                }],
            yAxis: {
                max:150,
                axisLine: {
                    show: false
                },
                axisTick: {
                    show: false
                },
                splitNumber: 4,
                splitLine: {
                    lineStyle: {
                        type: "dashed"
                    }
                },
                axisLabel: {
                    show: false,
                    textStyle: {
                        color: '#999'
                    }
                }
            },
            dataZoom: [
                {
                    type: 'inside'
                }
            ],
            series: [
                {
                    data: data,
                    type: "bar",
                    label: {
                        normal: {
                            position: "top",
                            show: function () {
                                if (ticket == true) {
                                    return true;
                                }
                                else {
                                    return false;
                                }
                            }(),
                            textStyle: {
                                color: "red",
                                fontSize: 15
                            }
                        }
                    }
                },
                {
                    type: 'bar',
                    barGap: '-100%',
                    barCategoryGap: '40%',
                    animation: false
                },
                {
                    type: 'bar',
                    itemStyle: {
                        normal: {
                            color: new echarts.graphic.LinearGradient(
                                    0, 0, 0, 1,
                                    [
                                        {offset: 0, color: '#33cccc'},
                                        {offset: 1, color: '#2980b9'}
                                    ]
                            )
                        }
                    },
                    data: data
                }
            ]
        };
    }
    makemap();
    map.setOption(option);
</script>
<script name="show10">
    $("#show10").on("click", function () {
        makemap();
        map.setOption(option);
    })
</script>
<script name="showTicket">
    $("#showTicket").on("click", function () {
        makemap();
        map.setOption(option);
    })
</script>

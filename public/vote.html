<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>2017杭电十佳教师评选-为Ta投票</title>
    <link rel="stylesheet" href="./css/common.css">
    <link rel="stylesheet" href="./css/bars.css">
    <link rel="stylesheet" href="./css/utils.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<style>
    .red {
        font-size: 18px;
        font-weight: bold;
        letter-spacing: 3.6px;
        color: #ff6666;
    }

    .voteRules {
        margin: 30px auto;
        padding: 20px 15px 30px 15px;
        border-radius: 10px;
        background-color: #fcfcfc;
        box-shadow: 0 0 6px 0 #e0e0e0;
        color: #999999;
        text-align: center;
    }
    .voteRules .title {
        font-size: 24px;
        letter-spacing: 5px;
        font-weight: bold;
        margin-bottom: 20px;
    }
    .voteRules .content {
        line-height: 24px;
        font-size: 14px;
        max-width: 480px;
        margin: 0 auto;
        text-align: left;
    }

    .teacherBox {
        width: 19.5%;
        margin-bottom: 7px;
    }
    .teacherBox .number {
        line-height: 30px;
        padding: 3px;
        margin: auto;
        margin-bottom: 10px;
        border: 2px solid white;
        height: 30px;
        width: 30px;
        border-radius: 30px;
    }
    .teacherBox .number img {
        display: none;
        width: 70%;
        height: 70%;
        margin: 5px auto 0 auto;
    }
    .teacherBox .shade .content{
        width: 64px;
        height: 75px;
    }
    .teacherBox.active .shade {
        background-image: linear-gradient(to right, rgba(51, 204, 204, .5), rgba(41, 128, 185, .5));
    }
    .teacherBox.active .number {
        background: -webkit-gradient(linear,left top,left bottom,from(#2980b9),to(#33cccc));
    }
    .teacherBox.active .number span {
        display: none;
    }
    .teacherBox.active .number img {
        display: block;
    }

    .voteEnd .notice {
        font-size: 14px;
        margin-top: 40px;
        margin-bottom: 20px;
    }
    .result {
        padding: 0 12px;
        max-width: 700px;
        margin: auto;
    }
    .result .item {
        border-radius: 10px;
        background-color: #fcfcfc;
        box-shadow: 0 0 6px 0 #e0e0e0;
        text-align: left;
        padding: 10px 20px;
        font-size: 12px;
        color: #999999;
        margin-bottom: 15px;
    }
    .result .item > * {
        display: inline-block;
        vertical-align: middle;
    }
    .result .avatar {
        width: 60px;
        border-radius: 100px;
        margin-right: 20px;
    }
    .result .name {
        font-size: 16px;
        font-weight: bold;
        text-align: left;
        color: #666666;
        line-height: 28px;
    }
    .result .number {
        font-size: 20px;
        font-weight: bold;
        vertical-align: bottom;
    }
    .result .right {
        float: right;
        line-height: 60px;
    }

    .vote .timer {
        line-height: 40px;
        margin-bottom: 15px;
    }
    .submission {
        padding-top: 30px;
    }
    .submission .stress {
        font-size: 21px;
        letter-spacing: 4px;
    }
    .submission .notice {
        line-height: 26px;
        letter-spacing: 3px;
        font-size: 14px;
    }
    .submission .submit {
        letter-spacing: 4px;
        margin-top: 15px;
        width: 270px;
        height: 50px;
        background-color: #cccccc;
        font-size: 18px;
        pointer-events: none;
    }
    .submission .submit.active {
        background: linear-gradient(to right, #33cccc, #2980b9);
        cursor: pointer;
        pointer-events: auto;
    }

    .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, .7);
    }
    .modal .card {
        width: 255px;
        height: 410px;
        border-radius: 10px;
        background-color: #fcfcfc;
        box-shadow: 0 0 15px 0 #e0e0e0;
        padding: 40px;
    }
    .modal .image {
        display: block;
        width: 40px;
        margin: auto;
        margin-top: 55px;
    }
    .modal .note {
        margin: 60px 0;
        font-size: 14px;
        font-weight: bold;
        color: #666666;
    }
    .modal .close {
        position: absolute;
        top: 20px;
        right: 20px;
        width: 20px;
        cursor: pointer;
        transition: .5s;
    }
    .modal .close:hover {
        transform: rotateZ(90deg);
    }
    .modal input {
        width: 100%;
        height: 50px;
        outline: none;
        border: none;
        font-size: 18px;
        line-height: 50px;
        text-align: center;
        background-color: #f0f0f0;
    }
    .modal .submit {
        height: 50px;
        line-height: 50px;
        margin: 30px 0;
        color: white;
        font-weight: bold;
        background: linear-gradient(to right, #33cccc, #2980b9);
    }

    @media screen and (max-width: 700px) {
        .voteRules {
            margin-left: 12px!important;
            margin-right: 12px!important;
        }
        .votelist {
            padding: 0 12px;
        }
        .votelist .teacherBox {
            width: 49%;
            margin-bottom: 6px;
        }
    }
</style>

<body>
<div class="topbar">
    <div class="topbarContainer">
        <img src="./pic/logo.png" class="logo" alt=" ">
        <!--<a class="title" href="./talentShow.html">-->
            <!--<div>风采展示</div>-->
            <!--<div class="underline"></div>-->
        <!--</a>-->
        <div class="title active">
            <div>为Ta投票</div>
            <div class="underline"></div>
        </div>
    </div>
</div>
<div class="container">
    <img class="banner" src="http://static.hduin.club/bestTeacher/banner_pc.jpg"/>
    <img class="banner phone" src="http://static.hduin.club/bestTeacher/banner_phone.jpg"/>
    <div class="voteRules">
        <div class="title">投票规则</div>
        <div class="content">
            <div>● 此活动采取评委团无记名投票，评委团由专家评委和师生评委组成；</div>
            <div>● 每位评委限投一次，每次选8-10人为有效票；</div>
            <div>● 专家评委投一票计3票、师生评委投一票计1票；</div>
            <div>● 最终得票数排在前10名的候选人获得”十佳教师 & 师德先进个人“称号。</div>
        </div>
    </div>
    <div class="voteNotStart none">
        <div class="red">投票尚未开始</div>
    </div>
    <div class="voteEnd none">
        <div class="red">投票已结束</div>
        <!--<div class="notice">投票结果如下（只显示前10名得票数）</div>-->
        <div class="notice">投票结果如下</div>
        <div class="result"></div>
    </div>
    <div class="vote none">
        <div>距投票结束还有</div>
        <div class="timer red"></div>
        <div class="votelist"></div>
    </div>
    <div class="submission none">
        <!--<div class="stress"><span class="selectNumber">0</span>/20</div>-->
        <div class="notice">(每人只能投一票)</div>
        <input type="submit" value="提 交" class="submit">
    </div>
</div>

<div class="modal none">
    <div class="absolute center card">
        <img class="close" src="./pic/icon/close.png" alt="">
        <img class="image" src="./pic/icon/bell.png" alt="">
        <div class="note">此活动采取【评委投票制】，请输入您的【邀请码】以验证评委身份。</div>
        <input type="text" maxlength="5">
        <div class="submit">确 认</div>
    </div>
</div>

<div class="copyright">&copy; 2017.Powered by RedHome Studio 红色家园</div>

<script src="https://cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>
<script src="./js/teacherData.js"></script>
<script src="./js/utils.js"></script>
<script src="https://cdn.bootcss.com/socket.io/1.7.3/socket.io.min.js"></script>
<script id="teacherResult" type="application/xml">
    <div class="item">
        <div class="right"><span class="number stress">__score__</span> / 票</div>
        <img class="avatar" src="http://static.hduin.club/bestTeacher/teacher/__name__.jpg" alt=""/>
        <div>
            <div class="name">__name__</div>
            <div class="department">__department__</div>
        </div>
    </div>
</script>
<script id="teacherContainer" type="application/xml">
    <div class="teacherBox" id="__id__">
        <img src="http://static.hduin.club/bestTeacher/teacherLong/__name__.jpg"/>
        <div class="absolute center shade">
            <div class="absolute center content">
                <div class="number">
                    <span>__number__</span>
                    <img src='./pic/icon/check.png'/>
                </div>
                <div>__name__</div>
            </div>
        </div>
    </div>
</script>
<script>
    $(function () {
        // init teacher list
        var teacherContainerCode = $('#teacherContainer').html();
        var resultCode = $('#teacherResult').html();
        $voteList = $('.votelist');
        teacherInfo.forEach(function (e) {
            var str = teacherContainerCode.replaceAll({
                '__name__': e.name,
                '__id__': e.id,
                '__number__': e.number
            });
            $voteList.append(str)
        });
        $voteList.append('<div class="teacherBox disabled"></div>');

        // init vote state
        var $vote = $('.vote');
        var $voteNotStart = $('.voteNotStart');
        var $voteEnd = $('.voteEnd');
        var $submission = $('.submission');
        var $timeContainer = $('.vote .timer');
        $.ajax({
            url: '/common/time',
            method: 'get',
            success: function (data) {
                initPage(data);
            }, error: function () {
                alert("网络连接失败，请刷新后重试");
            }
        });

        // 根据后台时间情况判断界面显示样式
        function initPage(data) {
            if (!data.time) {
                $voteNotStart.fadeIn();
                return
            }
            var timeNow = new Date().getTime();
            var timeEnd = data.time + 1000 * 60 * data.duration;
            var surplus = timeEnd - timeNow;
            if (surplus < 0) {
                showResult();
                return
            }
            checkVoteStatus(data.time);
            $vote.fadeIn();
            startTime($timeContainer, surplus, function () {
                $vote.fadeOut();
                showResult();
            })
        }
        // 检查是否投过票
        function checkVoteStatus(startTime) {
            var voteStatus = localStorage.getItem('voteStatus');
            var start = localStorage.getItem('startTime');
            // 根据start time判断是否是上一次投票
            if (!voteStatus || start != startTime) {
                localStorage.clear();
                localStorage.setItem('startTime', startTime);
                $submission.fadeIn();
                return
            }
            voteStatus = voteStatus.split(',');
            $.each($('.teacherBox'), function (i, e) {
                var $e = $(e);
                $e.addClass('disabled');
                if (voteStatus.indexOf( $e.attr('id') ) !== -1) {
                    $e.addClass('active')
                }
            });
        }
        // 展示结果
        function showResult() {
            $voteEnd.fadeIn();
            var showNum = 9;
            var $resultContainer = $voteEnd.find('.result');
            $.ajax({
                url: '/common/getResult',
                success: function (data) {
                    var res = sortScore(data.result);
                    for (var i = 0; i < showNum;i ++) {
                        var v = res[i];
                        var info = teacherInfo[ v.id-1 ];
                        var str = resultCode.replaceAll({
                            '__name__': info.name,
                            '__department__': info.department,
                            '__score__': v.number_of_votes
                        });
                        $resultContainer.append(str);
                    }
                },
                error: function () {
                    alert('获取结果失败，请刷新后重试')
                }
            })
        }

        // teacherbox click

//        var $submit = $submission.find('[type=submit]');
//        var $selectNumber = $submission.find('.selectNumber');
//        var selectNumber = 0;
//        $vote.on("click", '.teacherBox:not(.disabled)', function () {
//            var $this = $(this);
//            if ($this.hasClass('active')) {
//                $this.removeClass('active');
//                selectNumber--;
//            } else {
//                $this.addClass('active');
//                selectNumber++;
//            }
//
//            $selectNumber.text(selectNumber);
//            // submit button style
//            if (selectNumber >= 8 && selectNumber <= 10) {
//                $submit.addClass('active')
//            } else {
//                $submit.removeClass('active')
//            }
//        });

        var $submit = $submission.find('[type=submit]');
        $vote.on("click", '.teacherBox:not(.disabled)', function () {
            var $this = $(this);
            var $beforeActive = $('.active');
            if ($this.hasClass('active')) {
                $this.removeClass('active');
                $submit.removeClass('active');
            } else {
                $beforeActive.removeClass('active');
                $this.addClass('active');
                $submit.addClass('active');
            }
        });

        // 浮动窗口
//        $modal = $('.modal');
//        $submit.on('click', function () {
//            $modal.fadeIn();
//        });
//        $modal.find('.close').on('click', function () {
//            $modal.fadeOut();
//        });
//        $modal.find('.submit').on('click', function () {
//            var code = $modal.find('input').val();
//            if (!code || code.length !== 5) {
//                return alert("请输入正确的邀请码");
//            }
//
//            var ids = [];
//            $.each($('.teacherBox.active'), function (i, e) {
//                ids.push( $(e).attr('id') )
//            });
//            $.ajax({
//                url: '/common/vote',
//                method: 'post',
//                data: {
//                    teacherId: ids,
//                    code: code
//                },
//                success: function () {
//                    localStorage.setItem('voteStatus', ids.join(','));
//                    alert('投票成功，感谢您宝贵的一票~');
//                    window.location.href = '/vote.html?time=' + new Date().getTime();
//                },
//                error: function (err) {
//                    if (err.responseJSON && err.responseJSON.status == 'error') {
//                        alert(err.responseJSON.msg);
//                    } else {
//                        alert('服务器开小差了，请稍后重试');
//                    }
//                }
//            })
//        })
        $submit.on('click', function () {
            var ids = [];
            $.each($('.teacherBox.active'), function (i, e) {
                ids.push( $(e).attr('id') )
            });
            $.ajax({
                url: '/common/vote',
                method: 'post',
                data: {
                    teacherId: ids,
                    code: 19465
                },
                success: function () {
                    localStorage.setItem('voteStatus', ids.join(','));
                    alert('投票成功，感谢您宝贵的一票~');
                    window.location.href = '/vote.html?time=' + new Date().getTime();
                },
                error: function (err) {
                    localStorage.setItem('voteStatus', ids.join(','));
                    alert('投票成功，感谢您宝贵的一票~');
                    window.location.href = '/vote.html?time=' + new Date().getTime();
//                    if (err.responseJSON && err.responseJSON.status == 'error') {
//                        alert(err.responseJSON.msg);
//                    } else {
//                        alert('服务器开小差了，请稍后重试');
//                    }
                }
            })
        });

//        // web socket
//        var socket = io.connect('/');
//        socket.on('startVote', function (data) {
//            $voteNotStart.fadeOut();
//            $voteEnd.fadeOut();
//            initPage(data);
//        });
//        socket.on('reset', function () {
//            localStorage.clear();
//            window.location.href = '/vote.html?time=' + new Date().getTime();
//        })
    })
</script>
</body>
</html>
